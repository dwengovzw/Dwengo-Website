---
permalink: /bot/
---


<!-- Chat Widget -->
<div id="dwengo-chat-widget">
  <div id="dwengo-chat-header">Chat with our Bot</div>
  <div id="dwengo-chat-messages"></div>
  <div id="dwengo-chat-input">
    <input type="text" id="dwengo-chat-text" placeholder="Type your message..." />
    <button id="dwengo-chat-send">Send</button>
  </div>
</div>

<style>
#dwengo-chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 300px;
  max-height: 400px;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  font-family: Arial, sans-serif;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  overflow: hidden;
  z-index: 9999;
}
#dwengo-chat-header {
  background: #87C544;
  color: white;
  padding: 10px;
  font-weight: bold;
  text-align: center;
}
#dwengo-chat-messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  font-size: 14px;
}
#dwengo-chat-messages .user {
  text-align: right;
  color: #0077cc;
  margin: 5px 0;
}
#dwengo-chat-messages .bot {
  text-align: left;
  color: #333;
  margin: 5px 0;
  white-space: pre-wrap;
}
#dwengo-chat-messages .bot.loading {
  color: #888;
  font-style: italic;
}
#dwengo-chat-input {
  display: flex;
  border-top: 1px solid #ccc;
}
#dwengo-chat-input input {
  flex: 1;
  border: none;
  padding: 10px;
  font-size: 14px;
}
#dwengo-chat-input button {
  background: #87C544;
  border: none;
  color: white;
  padding: 0 15px;
  cursor: pointer;
}
#dwengo-chat-input button:hover {
  background: #6FA636;
}
</style>

<script>
const apiUrl = "https://kiks2.ilabt.imec.be/bot/v1/chat"; // adjust if hosted elsewhere
const TYPE_DELAY_MS = 25; // artificial delay per chunk (ms) to simulate typing
const LOADING_TEXT = "Thinkingâ€¦"; // placeholder shown while waiting for first tokens

document.getElementById("dwengo-chat-send").addEventListener("click", sendMessage);
document.getElementById("dwengo-chat-text").addEventListener("keypress", function(e) {
  if (e.key === "Enter") sendMessage();
});

async function sendMessage() {
  const input = document.getElementById("dwengo-chat-text");
  const message = input.value.trim();
  if (!message) return;

  appendMessage("user", message);
  input.value = "";

  // Create a placeholder for streaming response
  const botMsgElem = appendMessage("bot", LOADING_TEXT);
  botMsgElem.classList.add("loading");

  // Simple per-message typing queue to control render speed
  let started = false; // becomes true when first token arrives
  const queue = [];
  let typing = false;

  function enqueue(token) {
    if (!token) return;
    if (!started) {
      // First token: clear placeholder and switch to normal style
      botMsgElem.textContent = "";
      botMsgElem.classList.remove("loading");
      started = true;
    }
    // If the token contains HTML, queue it as a whole chunk to avoid breaking tags
    if (token.includes("<")) {
      queue.push(token + " ");
    } else {
      // Otherwise split into words for a smoother typing effect
      const parts = token.split(/\s+/).filter(Boolean);
      if (parts.length === 0) {
        queue.push(" ");
      } else {
        for (const w of parts) queue.push(w + " ");
      }
    }
    if (!typing) processQueue();
  }

  async function processQueue() {
    typing = true;
    while (queue.length) {
      const chunk = queue.shift();
      // Add a small delay so it looks like the text is being written
      await new Promise(res => setTimeout(res, TYPE_DELAY_MS));
      botMsgElem.innerHTML += chunk; // use HTML to render links
      scrollMessages();
    }
    typing = false;
  }

  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "text/event-stream",
        "DWENGO-API-KEY": "MBIyVRAQ2cwkeYmyMtlEgZqcuqefB1wgQXftC8G06DWrunbrFILK6thzqgGw6AEXyg5loNG7yTeR4EjrTgB19K4ewuBaDlLFJWoGnLVGiHmLpTfTiSusHeqQWiCGi9DE" // adjust if required
      },
      body: JSON.stringify({ query: message, stream: true })
    });

    if (!response.ok || !response.body) {
      botMsgElem.textContent = "Error connecting to server.";
      botMsgElem.classList.remove("loading");
      return;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        const parts = buffer.split("\n\n");
        buffer = parts.pop(); // save incomplete part

        for (const part of parts) {
            if (part.startsWith("data:")) {
            let token = part.slice(5);
            token = cleanBotText(token); // clean it

            // Queue token for delayed rendering
            enqueue(token);
            }
        }
    }

    // If stream ended but no content arrived, replace placeholder with message
    if (!started) {
      botMsgElem.textContent = "No response from server.";
      botMsgElem.classList.remove("loading");
    }
  } catch (err) {
    botMsgElem.textContent = "Error fetching response.";
    botMsgElem.classList.remove("loading");
    console.error(err);
  }
}

function cleanBotText(text) {
  // Remove system/user tags
  text = text.replace(/<\|\/?(user|system)\|>/g, "");

  return text;
}

function appendMessage(sender, text, isHtml = false) {
  const messagesDiv = document.getElementById("dwengo-chat-messages");
  const msg = document.createElement("div");
  msg.className = sender;
  
  if (isHtml) {
    msg.innerHTML = text;
  } else {
    msg.textContent = text;
  }

  messagesDiv.appendChild(msg);
  scrollMessages();
  return msg; // return the element so we can update it while streaming
}

function scrollMessages() {
  const messagesDiv = document.getElementById("dwengo-chat-messages");
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>
