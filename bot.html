---
permalink: /bot/
---


<!-- Chat Widget -->
<div id="dwengo-chat-widget">
  <div id="dwengo-chat-header">{{ site.translations[site.lang].bot.title }}</div>
  <div id="dwengo-chat-messages"></div>
  <div id="dwengo-chat-input">
    <input type="text" id="dwengo-chat-text" placeholder="{{ site.translations[site.lang].bot.placeholder }}" />
    <button id="dwengo-chat-send">{{ site.translations[site.lang].bot.send }}</button>
  </div>
</div>

<style>
#dwengo-chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 300px;
  max-height: 400px;
  background: white;
  border: 1px solid #ccc;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  font-family: Arial, sans-serif;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  overflow: hidden;
  z-index: 9999;
}
#dwengo-chat-header {
  background: #87C544;
  color: white;
  padding: 10px;
  font-weight: bold;
  text-align: center;
}
#dwengo-chat-messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  font-size: 14px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: #fff;
}
#dwengo-chat-messages .user,
#dwengo-chat-messages .bot {
  position: relative;
  max-width: 85%;
  padding: 10px 12px;
  border-radius: 16px;
  line-height: 1.4;
  box-shadow: 0 1px 2px rgba(0,0,0,0.06);
}
#dwengo-chat-messages .user {
  align-self: flex-end;
  background: #eaf6d9; /* light green */
  border: 1px solid rgba(133,196,65,0.35);
  color: #2f6f1a; /* dark green text */
  text-align: left;
}
#dwengo-chat-messages .bot {
  align-self: flex-start;
  background: #f2f8e9;
  border: 1px solid rgba(133,196,65,0.25);
  color: #2d2d2d;
  white-space: pre-wrap;
}
#dwengo-chat-messages .user::after {
  content: "";
  position: absolute;
  right: -6px;
  bottom: 10px;
  width: 0; height: 0;
  border-style: solid;
  border-width: 6px 0 6px 6px;
  border-color: transparent transparent transparent #eaf6d9;
}
#dwengo-chat-messages .bot::after {
  content: "";
  position: absolute;
  left: -6px;
  bottom: 10px;
  width: 0; height: 0;
  border-style: solid;
  border-width: 6px 6px 6px 0;
  border-color: transparent #f2f8e9 transparent transparent;
}
#dwengo-chat-messages .bot.loading {
  color: #888;
  font-style: italic;
}
/* Link styles inside chat */
#dwengo-chat-messages a {
  color: #85c441;
  text-decoration: underline;
}
#dwengo-chat-messages a:hover { color: #6FA636; }
#dwengo-chat-messages a:active { color: #5A8E2F; }
#dwengo-chat-messages a:visited { color: #6FA636; }
#dwengo-chat-input {
  display: flex;
  border-top: 1px solid #ccc;
}
#dwengo-chat-input input {
  flex: 1;
  border: none;
  padding: 10px;
  font-size: 14px;
}
#dwengo-chat-input button {
  background: #87C544;
  border: none;
  color: white;
  padding: 0 15px;
  cursor: pointer;
}
#dwengo-chat-input button:hover {
  background: #6FA636;
}
</style>

<script>
const apiUrl = "https://kiks2.ilabt.imec.be/bot/v1/chat"; // adjust if hosted elsewhere
const TYPE_DELAY_MS = 25; // artificial delay per chunk (ms) to simulate typing
const LOADING_TEXT = "{{ site.translations[site.lang].bot.thinking }}"; // placeholder shown while waiting for first tokens

document.getElementById("dwengo-chat-send").addEventListener("click", sendMessage);
document.getElementById("dwengo-chat-text").addEventListener("keypress", function(e) {
  if (e.key === "Enter") sendMessage();
});

async function sendMessage() {
  const input = document.getElementById("dwengo-chat-text");
  const message = input.value.trim();
  if (!message) return;

  appendMessage("user", message);
  input.value = "";

  // Create a placeholder for streaming response
  const botMsgElem = appendMessage("bot", LOADING_TEXT);
  botMsgElem.classList.add("loading");

  // Simple per-message typing queue to control render speed
  let started = false; // becomes true when first token arrives
  const queue = [];
  let typing = false;

  function enqueue(token) {
    if (!token) return;
    if (!started) {
      // First token: clear placeholder and switch to normal style
      botMsgElem.textContent = "";
      botMsgElem.classList.remove("loading");
      started = true;
    }
    // If the token contains HTML, queue it as a whole chunk to avoid breaking tags
    if (token.includes("<")) {
      queue.push(token);
    } else {
      // Otherwise split into words for a smoother typing effect
      const parts = token.split(/\s+/).filter(Boolean);
      for (let i = 0; i < parts.length; i++) {
        queue.push(parts[i]);
      }
    }
    if (!typing) processQueue();
  }

  async function processQueue() {
    typing = true;
    while (queue.length) {
      const chunk = queue.shift();
      // Add a small delay so it looks like the text is being written
      await new Promise(res => setTimeout(res, TYPE_DELAY_MS));
      // Insert a space before non-punctuation words when appropriate
      const isHtml = chunk.includes("<");
      if (!isHtml) {
        const isPunctOnly = /^[\.,!?;:)\]\}â€¦]+$/.test(chunk);
        if (!isPunctOnly) {
          const last = (botMsgElem.textContent || "").slice(-1);
          if (last && !/\s/.test(last) && !/[([{]/.test(last)) {
            botMsgElem.innerHTML += " ";
          }
        }
      }
      botMsgElem.innerHTML += chunk; // use HTML to render links
      scrollMessages();
    }
    typing = false;
  }

  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "text/event-stream",
        "DWENGO-API-KEY": "MBIyVRAQ2cwkeYmyMtlEgZqcuqefB1wgQXftC8G06DWrunbrFILK6thzqgGw6AEXyg5loNG7yTeR4EjrTgB19K4ewuBaDlLFJWoGnLVGiHmLpTfTiSusHeqQWiCGi9DE" // adjust if required
      },
      body: JSON.stringify({ query: message, stream: true })
    });

    if (!response.ok || !response.body) {
      botMsgElem.textContent = "Error connecting to server.";
      botMsgElem.classList.remove("loading");
      return;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        const parts = buffer.split("\n\n");
        buffer = parts.pop(); // save incomplete part

        for (const part of parts) {
            if (part.startsWith("data:")) {
            let token = part.slice(5);
            token = cleanBotText(token); // clean it

            // Queue token for delayed rendering
            enqueue(token);
            }
        }
    }

    // If stream ended but no content arrived, replace placeholder with message
    if (!started) {
      botMsgElem.textContent = "No response from server.";
      botMsgElem.classList.remove("loading");
    }
  } catch (err) {
    botMsgElem.textContent = "Error fetching response.";
    botMsgElem.classList.remove("loading");
    console.error(err);
  }
}

function cleanBotText(text) {
  // Remove system/user tags
  text = text.replace(/<\|\/?(user|system)\|>/g, "");

  return text;
}

function appendMessage(sender, text, isHtml = false) {
  const messagesDiv = document.getElementById("dwengo-chat-messages");
  const msg = document.createElement("div");
  msg.className = sender;
  
  if (isHtml) {
    msg.innerHTML = text;
  } else {
    msg.textContent = text;
  }

  messagesDiv.appendChild(msg);
  scrollMessages();
  return msg; // return the element so we can update it while streaming
}

function scrollMessages() {
  const messagesDiv = document.getElementById("dwengo-chat-messages");
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>
